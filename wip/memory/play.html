<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Memory</title>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="memory.css">
  </head>
  <body>
    <svg>
      <defs>
        <pattern id="lines" patternUnits="userSpaceOnUse" x="0" y="0"
          width="100" height="100">
          <g stroke="#55bef2"/>
        </pattern>
        <filter id="shadow" filterUnits="userSpaceOnUse" x="0" y="0"
          width="110%" height="110%">
          <feGaussianBlur in="SourceAlpha" stdDeviation="4" result="blur"/>
          <feOffset in="blur" dx="2" dy="2"/>
        </filter>
        <g id="back">
          <rect x="10" y="10" width="80" height="80" fill="white"/>
          <rect x="12" y="12" width="76" height="76" fill="url(#lines)"/>
        </g>
        <g id="front">
          <rect x="10" y="10" width="80" height="80" fill="white"
            filter="url(#shadow)"/>
          <rect x="10" y="10" width="80" height="80" fill="white"/>
          <rect x="12" y="12" width="76" height="76" fill="#fcfbe3"/>
        </g>
        <rect id="mask" x="10" y="10" width="80" height="80" fill-opacity="0"/>
        <g id="donut">
          <use xlink:href="#front"/>
          <circle cx="50" cy="50" r="30"/>
          <circle cx="50" cy="50" r="12" fill="#fcfbe3"/>
        </g>
        <g id="square">
          <use xlink:href="#front"/>
        </g>
        <g id="triangle">
          <use xlink:href="#front"/>
        </g>
        <g id="hexagon">
          <use xlink:href="#front"/>
        </g>
        <g id="star">
          <use xlink:href="#front"/>
        </g>
        <g id="cross">
          <use xlink:href="#front"/>
          <polygon points="80,40 60,40 60,20 40,20 40,40 20,40 20,60 40,60
            40,80 60,80 60,60 80,60"/>
        </g>
      </defs>
      <g id="tiles"/>
    </svg>
    <script src="../../flexo.js"></script>
    <script src="memory.js"></script>

    <script>
      memory.make_shapes();

      var args = flexo.get_args({ w: 6, h: 4, players: 2, reveal: "false" });
      var w = parseInt(args.w, 10);
      var h = parseInt(args.h, 10);
      if (w < 1 || h < 1 || w * h % 2 !== 0 ||
        w * h > memory.TILES.length * 2) {
        alert("Incorrect game size!");
        window.location = "index.html";
      }
      memory.game = memory.make_game(parseInt(args.players, 10));
      var svg = document.querySelector("svg");
      svg.setAttribute("viewBox", "0 0 {0} {1}".fmt(w * 100, h * 100));

      var g = document.getElementById("tiles");
      var tiles = memory.setup_tiles(g, w, h);

      /*
      function add_tile(x, y)
      {
        var x_ = x * 100 + flexo.random_number(-2, 2);
        var y_ = y * 100 + flexo.random_number(-2, 2);
        var a = flexo.random_number(-2, 2);
        var transform = "translate({0}, {1}) rotate({2}, 50, 50)"
          .fmt(x_, y_, a);
        var tile = flexo.svg_href("use", "#" + tiles[x * args.h + y][0],
          { transform: transform, fill: tiles[x * args.h + y][1] });
        var back = flexo.svg_href("use", "#back", { transform: transform });
        g.appendChild(tile);
        if (!flexo.is_true(args.reveal)) {
          g.appendChild(back);
          back.addEventListener("click", function(e) { reveal(tile); }, false);
        }
      }

      var moves = 0;
      var revealed;
      var timeout;

      function reveal(tile)
      {
        if (timeout) return;
        tile.nextSibling.style.display = "none";
        if (revealed) {
          ++moves;
          if (tile.getAttribute("fill") === revealed.getAttribute("fill") &&
            tile.getAttributeNS(flexo.XLINK_NS, "href") ===
            revealed.getAttributeNS(flexo.XLINK_NS, "href")) {
            timeout = setTimeout(function() {
                alert("Match!");
                flexo.safe_remove(tile.nextSibling);
                flexo.safe_remove(tile);
                flexo.safe_remove(revealed.nextSibling);
                flexo.safe_remove(revealed);
                revealed = undefined;
                timeout = null;
                if (!g.querySelector("use")) {
                  setTimeout(function() {
                      alert("Cleared the board in {0} moves.".fmt(moves));
                    }, 0);
                }
              }, 0);
          } else {
            timeout = setTimeout(function() {
                alert("No match!");
                tile.nextSibling.style.display = "";
                revealed.nextSibling.style.display = "";
                revealed = undefined;
                timeout = null;
              }, 0);
          }
        } else {
          revealed = tile;
        }
      }
      */

    </script>

  </body>
</html>
