<svg xmlns="http://www.w3.org/2000/svg" version="1.1"
  xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="-200 -200 400 400">

  <script xlink:href="../../flexo.js"/>

  <defs>
    <style type="text/css"><![CDATA[
      .segment rect { stroke: black; fill: none; }
      .handle { fill-opacity: 0; }
    ]]></style>
  </defs>

  <g class="segment">
    <rect width="100" height="20" rx="10" ry="10"/>
    <circle cx="10" cy="10" r="3"/>
    <circle cx="90" cy="10" r="3"/>
  </g>

  <script><![CDATA[

    [].forEach.call(document.querySelectorAll("circle"), function(circle) {
        var segment = circle.parentNode;
        var rect = segment.firstElementChild;
        var r = flexo.get_float_trait(rect, "rx");
        var cx = flexo.get_float_trait(circle, "cx");
        var cy = flexo.get_float_trait(circle, "cy");
        var handle = flexo.svg("circle", { "class": "handle", cx: cx, cy: cy,
          r: r });
        var width = flexo.get_float_trait(rect, "width");
        offset = cx < width - cx ? Math.PI : 0;
        cx = width - cx;  // opposite cx for rotation center
        handle.addEventListener("mousedown", function(e) {
            e.preventDefault();
            var a;
            var up = function(e) {
              document.removeEventListener("mousemove", move, false);
              document.removeEventListener("mouseup", up, false);
              offset = a;
            };
            var move = function(e) {
              var p = flexo.event_svg_point(e);
              a = Math.atan2(p.y - cy, p.x - cx) + offset;
              segment.setAttribute("transform", "rotate({0}, {1}, {2})"
                .fmt(a / Math.PI * 180, cx, cy));
            };
            document.addEventListener("mousemove", move, false);
            document.addEventListener("mouseup", up, false);
          }, false);
        segment.appendChild(handle);
      });

  ]]></script>

</svg>
