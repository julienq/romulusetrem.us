<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Snake</title>
    <meta charset="UTF-8">
    <meta http-equiv="cache-control" content="no-cache">
    <script src="../../flexo.js"></script>
    <script src="zap.js"></script>
    <style>
      body { font-family: Univers, "Helvetica Neue", Helvetica, sans-serif; }
      .zap-frame { background-color: black }
      .zap-frame { width: 100%; }
      #zap:focus { outline: 0; }
    </style>
  </head>
  <body>
    <h1 class="zap">Zap</h1>
    <div id="zap"></div>
    <script>

      zap.title = "Snake";
      var frame = zap.frame(400, 300);
      var scene = zap.scene();
      frame.add_scene(scene);

      scene.add((function(x, y)
      {
        var snake = zap.svg("path", { "stroke-width": 20, stroke: "#8f0",
          "stroke-linecap": "round", "stroke-linejoin": "round", id: "snake" });
        var direction = 0;
        Object.defineProperty(snake, "direction", { enumerable: true,
            get: function() { return direction; },
            set: function(d) {
              if (Math.abs(d - direction) !== 2) direction = d;
            }
          });
        var segments = [direction];
        snake.update_path = function()
        {
          this.element.setAttribute("d", "M{0},{1}".fmt(x, y) +
            segments.map(function(d) {
                return ["h-10", "v10", "h10", "v-10"][d];
              }).join(""));
        };
        snake.grow = function()
        {
          segments.unshift(direction);
          x += 10 * [1, 0, -1, 0][direction];
          y += 10 * [0, -1, 0, 1][direction];
          this.update_path();
        };
        snake.move = function()
        {
          segments.pop();
          this.grow();
        };
        snake.is_in_path = function(x_, y_)
        {
          var xc = x;
          var yc = y;
          for (var i = 0, n = segments.length; i < n; ++i) {
            xc += 20 * [-1, 0, 1, 0][segments[i]];
            yc += 20 * [0, 1, 0, -1][segments[i]];
            if (Math.abs(xc - x_) <= 10 && Math.abs(yc - y_) < 10) return true;
          }
          return Math.abs(xc - x_) <= 10 && Math.abs(yc - y_) < 10;
        };
        snake.update_path();
        flexo.getter_setter(snake, "x", function() { return x; });
        flexo.getter_setter(snake, "y", function() { return y; });
        return snake;
      })(frame.width / 2 + 10, frame.height / 2 + 10));

      var count = 0;
      var rate = 4;

      scene.add((function()
      {
        var apple = zap.svg("circle", { fill: "red", r: 10, id: "apple" });
        apple.random_position = function() {
          this.cx = 10 + 20 *
            flexo.random_int(0, this.scene.frame.width / 20 - 1);
          this.cy = 10 + 20 *
            flexo.random_int(0, this.scene.frame.height / 20 - 1);
        };
        return apple;
      })());

      scene.$apple.random_position();

      scene.tick = function(t)
      {
        if (this.frame.keys.right) {
          this.$snake.direction = 0;
        } else if (this.frame.keys.left) {
          this.$snake.direction = 2;
        } else if (this.frame.keys.up) {
          this.$snake.direction = 1;
        } else if (this.frame.keys.down) {
          this.$snake.direction = 3;
        }
        if (count++ === rate) {
          count = 0;
          if (this.$snake.x < 0 || this.$snake.x > frame.width ||
            this.$snake.y < 0 || this.$snake.y > frame.height ||
            this.$snake.is_in_path(this.$snake.x, this.$snake.y)) {
            this.running = false;
          } else if (Math.abs(this.$snake.x - this.$apple.cx) <= 10 &&
            Math.abs(this.$snake.y - this.$apple.cy) <= 10) {
            this.$snake.grow();
            this.$apple.random_position();
          } else {
            this.$snake.move();
          }
        }
      };

    </script>
  </body>
</html>
